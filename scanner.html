<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lecteur VIN Minimaliste</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background: #000;
            text-align: center;
            color: white;
            touch-action: manipulation;
        }
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            overflow: hidden;
        }
        #video {
            width: 100%;
            display: block;
            border-radius: 8px;
        }
        .guide-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(0, 255, 0, 0.8);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
            z-index: 10;
        }
        .focus-area {
            position: absolute;
            top: calc(50% - 50px);
            left: 10%;
            right: 10%;
            height: 100px;
            border-left: 2px dashed rgba(0, 255, 0, 0.5);
            border-right: 2px dashed rgba(0, 255, 0, 0.5);
            pointer-events: none;
        }
        button {
            padding: 16px 32px;
            font-size: 18px;
            border-radius: 50px;
            border: none;
            background: #007AFF;
            color: white;
            font-weight: 600;
            margin: 15px 5px;
            min-width: 200px;
            cursor: pointer;
        }
        #captureBtn {
            background: #34C759;
            display: none;
        }
        #result {
            background: rgba(40, 40, 40, 0.9);
            border-radius: 12px;
            padding: 25px;
            margin: 30px auto;
            max-width: 500px;
            display: none;
        }
        #vinResult {
            font-family: 'Courier New', monospace;
            font-size: 28px;
            letter-spacing: 3px;
            margin: 25px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            font-weight: bold;
        }
        .instruction {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            color: white;
            text-shadow: 0 1px 3px black;
            font-size: 16px;
            padding: 0 20px;
        }
    </style>
</head>
<body>
    <h1 style="margin-bottom: 30px;">Alignez le VIN</h1>
    
    <div class="scanner-container">
        <video id="video" playsinline webkit-playsinline></video>
        <div class="guide-line"></div>
        <div class="focus-area"></div>
        <div class="instruction">Placez la ligne verte sous les caractères du VIN</div>
    </div>
    
    <button id="startBtn">ACTIVER LA CAMÉRA</button>
    <button id="captureBtn">LIRE LE VIN</button>
    
    <div id="result">
        <h3 style="margin-top: 0;">VIN DÉTECTÉ :</h3>
        <div id="vinResult"></div>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button id="confirmBtn" style="background: #34C759;">VALIDER</button>
            <button id="retryBtn" style="background: #FF9500;">REESSAYER</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script>
        // Éléments DOM
        const video = document.getElementById('video');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const resultDiv = document.getElementById('result');
        const vinResult = document.getElementById('vinResult');
        
        let stream = null;
        let currentVin = '';

        // 1. Démarrer la caméra (mode paysage forcé)
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        width: { min: 1280 },
                        height: { min: 720 },
                        facingMode: { ideal: 'environment' }
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Forcer l'orientation landscape
                await video.play();
                await new Promise(resolve => {
                    video.onplaying = resolve;
                });
                
                startBtn.style.display = 'none';
                captureBtn.style.display = 'block';
                
                // Zoom visuel sur la zone de lecture
                video.style.objectFit = 'cover';
                
            } catch (err) {
                alert("Erreur : " + err.message);
                console.error(err);
            }
        }

        // 2. Capturer et lire le VIN
        async function captureVin() {
            captureBtn.disabled = true;
            captureBtn.textContent = "ANALYSE...";
            
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Adapter la taille du canvas à la zone de focus
                canvas.width = video.videoWidth;
                canvas.height = 100; // Hauteur réduite pour concentrer sur la ligne
                
                // Capturer uniquement autour de la ligne guide
                const yPos = Math.floor(video.videoHeight * 0.5) - 50;
                ctx.drawImage(video, 0, yPos, video.videoWidth, 100, 0, 0, canvas.width, canvas.height);
                
                // Amélioration du contraste (pré-traitement)
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    data[i] = data[i + 1] = data[i + 2] = avg > 128 ? 255 : 0;
                }
                ctx.putImageData(imageData, 0, 0);
                
                // Reconnaissance OCR avec Tesseract
                const { data: { text } } = await Tesseract.recognize(
                    canvas,
                    'eng',
                    {
                        tessedit_char_whitelist: 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789',
                        tessedit_pageseg_mode: 7, // Mode ligne unique
                        preserve_interword_spaces: 0
                    }
                );
                
                currentVin = text.replace(/[^A-HJ-NPR-Z0-9]/g, '').substring(0, 17).toUpperCase();
                
                if (currentVin.length === 17) {
                    vinResult.textContent = currentVin.match(/.{1,3}/g).join(' ');
                    resultDiv.style.display = 'block';
                    captureBtn.style.display = 'none';
                } else {
                    throw new Error("VIN incomplet");
                }
                
            } catch (err) {
                alert("Lecture impossible : " + err.message);
                console.error("OCR Error:", err);
            } finally {
                captureBtn.disabled = false;
                captureBtn.textContent = "LIRE LE VIN";
            }
        }

        // 3. Valider le VIN
        function confirmVin() {
            alert("VIN confirmé : " + currentVin);
            stopCamera();
            // Envoyer le VIN à votre système ici
        }

        // 4. Arrêter la caméra
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            startBtn.style.display = 'block';
            captureBtn.style.display = 'none';
            resultDiv.style.display = 'none';
        }

        // Événements
        startBtn.addEventListener('click', startCamera);
        captureBtn.addEventListener('click', captureVin);
        document.getElementById('confirmBtn').addEventListener('click', confirmVin);
        document.getElementById('retryBtn').addEventListener('click', () => {
            resultDiv.style.display = 'none';
            captureBtn.style.display = 'block';
        });

        // Nettoyage
        window.addEventListener('beforeunload', stopCamera);
    </script>
</body>
</html>
