<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Scanner VIN avec changement de cam√©ra</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #f0f0f5;
      margin: 0;
      padding: 40px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #222;
    }
    #container {
      background: white;
      padding: 25px 30px 40px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      max-width: 440px;
      width: 100%;
      text-align: center;
    }
    h1 {
      margin-bottom: 18px;
      font-weight: 700;
      color: #E31937;
    }
    #reader {
      margin: auto;
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 12px rgba(0,0,0,0.2);
    }
    #vin-display {
      margin-top: 20px;
      font-size: 20px;
      font-weight: 600;
      word-break: break-word;
      min-height: 28px;
      color: #222;
    }
    #status {
      margin-top: 6px;
      font-size: 16px;
      font-weight: 500;
      color: #666;
      min-height: 20px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 30px;
      justify-content: center;
      flex-wrap: wrap;
    }
    button {
      background-color: #E31937;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 17px;
      font-weight: 600;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      outline-offset: 2px;
      flex: 1;
      min-width: 150px;
    }
    button:hover {
      background-color: #b21427;
    }
    button.secondary {
      background-color: #0056B3;
    }
    button.secondary:hover {
      background-color: #003d7a;
    }
    #camera-switch {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
  </style>
</head>
<body>

  <div id="container">
    <h1>Scanner le VIN</h1>
    <div id="reader"></div>
    <div id="vin-display">Aucun VIN scann√©</div>
    <div id="status">En attente du scan...</div>
    
    <div class="button-group">
      <button id="switch-btn" class="secondary">
        <span id="camera-switch">
          <i class="fas fa-camera"></i> Changer de cam√©ra
        </span>
      </button>
      <button id="stop-btn">Arr√™ter le scan</button>
    </div>
  </div>

  <!-- Font Awesome pour l'ic√¥ne de cam√©ra -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <script>
    const vinDisplay = document.getElementById('vin-display');
    const status = document.getElementById('status');
    const stopBtn = document.getElementById('stop-btn');
    const switchBtn = document.getElementById('switch-btn');

    const html5QrCode = new Html5Qrcode("reader");
    let currentCamera = 'environment'; // 'environment' = cam√©ra arri√®re, 'user' = cam√©ra avant
    let isScanning = false;

    async function startScanner(cameraType) {
      try {
        // Arr√™ter le scan en cours si actif
        if (isScanning) {
          await html5QrCode.stop();
          isScanning = false;
        }

        // D√©marrer avec le type de cam√©ra sp√©cifi√©
        status.textContent = `Initialisation de la cam√©ra ${cameraType === 'environment' ? 'arri√®re' : 'avant'}...`;
        status.style.color = "#666";
        
        await html5QrCode.start(
          { facingMode: cameraType === 'environment' ? { exact: "environment" } : "user" },
          {
            fps: 10,
            qrbox: { width: 320, height: 100 },
            experimentalFeatures: { useBarCodeDetectorIfSupported: true }
          },
          decodedText => {
            const vin = decodedText.trim().toUpperCase();
            vinDisplay.textContent = `VIN scann√© : ${vin}`;

            if (/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
              status.textContent = "‚úÖ VIN valide";
              status.style.color = "#1a7f37";
              // Optionnel : Si vous voulez arr√™ter le scan apr√®s un VIN valide
              // html5QrCode.stop();
              // window.opener.postMessage({ vin: vin }, window.location.origin);
              // window.close();
            } else {
              status.textContent = "‚ö†Ô∏è VIN invalide (17 caract√®res sans I,O,Q)";
              status.style.color = "#b24343";
            }
          },
          errorMessage => {
            // Erreurs classiques ignor√©es
          }
        );

        isScanning = true;
        currentCamera = cameraType;
        status.textContent = `üéØ Scan en cours (cam√©ra ${cameraType === 'environment' ? 'arri√®re' : 'avant'})... Positionnez le VIN devant la cam√©ra.`;
        status.style.color = "#666";
        
      } catch (err) {
        status.textContent = `Erreur cam√©ra: ${err.message || err}`;
        status.style.color = "#b24343";
        console.error("Erreur de d√©marrage de la cam√©ra:", err);
        
        // Tenter l'autre cam√©ra en fallback
        const fallbackCamera = cameraType === 'environment' ? 'user' : 'environment';
        status.textContent += ` Tentative avec la cam√©ra ${fallbackCamera === 'environment' ? 'arri√®re' : 'avant'}...`;
        
        try {
          await startScanner(fallbackCamera);
        } catch (fallbackErr) {
          status.textContent = `Erreur irr√©cup√©rable: Aucune cam√©ra fonctionnelle. ${fallbackErr.message || fallbackErr}`;
          status.style.color = "#b24343";
          console.error("Erreur de d√©marrage de la cam√©ra de fallback:", fallbackErr);
        }
      }
    }

    // Bouton pour changer de cam√©ra
    switchBtn.addEventListener('click', async () => {
      const newCamera = currentCamera === 'environment' ? 'user' : 'environment';
      await startScanner(newCamera);
    });

    // Bouton pour arr√™ter le scan
    stopBtn.addEventListener('click', async () => {
      try {
        await html5QrCode.stop();
        isScanning = false;
        status.textContent = "‚èπÔ∏è Scan arr√™t√©.";
        status.style.color = "#666";
      } catch (err) {
        status.textContent = `Erreur √† l'arr√™t: ${err}`;
        status.style.color = "#b24343";
      }
    });

    // D√©marrer initialement avec la cam√©ra arri√®re
    startScanner('environment');
  </script>

</body>
</html>
