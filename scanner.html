<!DOCTYPE html>
<html lang="fr-CA">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VendreTonAutoRapide.ca | Scanner VIN</title>
    <style>
        /* Styles CSS (inchangés par rapport à la dernière version complète) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }
        h1 {
            color: #0056B3; /* Bleu QC */
            margin-bottom: 20px;
        }
        #videoContainer {
            position: relative;
            width: 100%;
            max-width: 600px;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }
        video {
            display: block;
            width: 100%;
            height: auto;
        }
        #vinOverlay {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 10%;
            border: 2px solid #E31937;
            transform: translate(-50%, -50%);
            pointer-events: none;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        button {
            background-color: #666;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: not-allowed;
            transition: background-color 0.3s ease;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        button:enabled {
            background-color: #2E8B57;
            cursor: pointer;
        }
        button:enabled:hover {
            background-color: #267a4b;
        }
        #result {
            margin-top: 30px;
            padding: 15px;
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            border-radius: 8px;
            min-height: 50px;
            width: 100%;
            max-width: 600px;
            font-size: 1.3em;
            font-weight: bold;
            color: #0056B3;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #status {
            margin-top: 15px;
            color: #666;
            font-size: 0.9em;
        }
        canvas {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Scanner de VIN Rapide</h1>
    <p>Cadrez le numéro d'identification du véhicule (VIN) dans la zone rouge.</p>

    <div id="videoContainer">
        <video id="video" playsinline autoplay></video>
        <div id="vinOverlay">Cadrez le VIN ici</div>
    </div>

    <button id="captureButton" disabled>Scanner le VIN</button>
    <p id="status">Chargement des ressources...</p>

    <div id="result">VIN : Non détecté</div>

    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const captureButton = document.getElementById('captureButton');
        const resultDiv = document.getElementById('result');
        const statusDiv = document.getElementById('status');

        let streaming = false;
        let opencvReady = false;
        let tesseractWorker = null;
        let tesseractReady = false;

        function onOpenCvReady() {
            opencvReady = true;
            statusDiv.textContent = 'OpenCV.js chargé. Démarrage de la caméra...';
            startCamera();
        }

        async function startCamera() {
            if (!opencvReady) {
                statusDiv.textContent = 'Erreur : OpenCV.js n\'est pas encore chargé. Veuillez recharger la page.';
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { ideal: "environment" },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });

                video.srcObject = stream;
                video.play();
                statusDiv.textContent = 'Caméra active. Chargement du moteur OCR...';

                video.addEventListener('canplay', () => {
                    if (!streaming) {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        streaming = true;
                        initializeTesseractWorker();
                    }
                }, { once: true });

            } catch (err) {
                console.error("Erreur d'accès à la caméra (tentative caméra arrière): ", err);
                statusDiv.textContent = 'Erreur: Impossible d\'accéder à la caméra arrière. Tentative avec la caméra frontale...';

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    video.srcObject = stream;
                    video.play();
                    statusDiv.textContent = 'Caméra frontale active. Chargement du moteur OCR...';
                    video.addEventListener('canplay', () => {
                        if (!streaming) {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            streaming = true;
                            initializeTesseractWorker();
                        }
                    }, { once: true });
                } catch (frontErr) {
                    console.error("Erreur d'accès à la caméra frontale: ", frontErr);
                    statusDiv.textContent = 'Erreur grave: Aucune caméra accessible. Veuillez vérifier vos permissions.';
                }
            }
        }

        async function initializeTesseractWorker() {
            if (tesseractWorker) return;

            statusDiv.textContent = 'Chargement du moteur OCR... (cela peut prendre un instant)';
            try {
                // MODIFICATION ICI : Suppression de la fonction logger pour éviter DataCloneError
                tesseractWorker = await Tesseract.createWorker({}); 

                // IMPORTANT : Pour une fiabilité "trop fiable", remplacez 'eng' par le nom de votre modèle VIN entraîné
                await tesseractWorker.loadLanguage('eng');
                await tesseractWorker.initialize('eng');
                
                await tesseractWorker.setParameters({
                    tessedit_char_whitelist: '0123456789ABCDEFGHJKLMNPRSTUVWXYZ'
                });

                tesseractReady = true;
                captureButton.disabled = false;
                statusDiv.textContent = 'Prêt à scanner le VIN. Cadrez-le et cliquez sur "Scanner".';

            } catch (error) {
                console.error("Erreur lors de l'initialisation de Tesseract: ", error);
                statusDiv.textContent = 'Erreur: Impossible de charger le moteur OCR. Vérifiez votre connexion internet et la console.';
                captureButton.disabled = true;
            }
        }

        function validateVIN(vin) {
            const cleanedVin = vin.toUpperCase().replace(/[^A-Z0-9]/g, '');

            if (cleanedVin.length !== 17) {
                console.warn(`Validation VIN: Longueur incorrecte (${cleanedVin.length} au lieu de 17).`);
                return null;
            }

            const disallowedCharsRegex = /[IOQ]/;
            if (disallowedCharsRegex.test(cleanedVin)) {
                console.warn(`Validation VIN: Contient des caractères non autorisés (I, O, Q).`);
                return null;
            }

            // *** RAPPEL CRUCIAL : IMPLÉMENTEZ ICI L'ALGORITHME DE CHECKSUM VIN POUR UNE FIABILITÉ À 100% ***
            // Sans le checksum, le VIN est validé uniquement sur le format, pas sur l'intégrité du numéro.
            // L'implémentation nécessite des tables de conversion et de poids selon ISO 3779/3780 ou SAE J853/J1892.

            return cleanedVin;
        }

        function tryCorrectCommonOcrErrors(vin) {
            let corrected = vin;
            corrected = corrected.replace(/O/g, '0');
            corrected = corrected.replace(/I/g, '1');
            corrected = corrected.replace(/Q/g, '0');
            corrected = corrected.replace(/S/g, '5');
            corrected = corrected.replace(/Z/g, '2');
            corrected = corrected.replace(/B/g, '8');
            corrected = corrected.replace(/[^0-9A-HJK-NPR-TV-Y]/g, ''); 
            return corrected;
        }

        captureButton.addEventListener('click', async () => {
            if (!streaming) {
                statusDiv.textContent = "La caméra n'est pas active.";
                return;
            }
            if (!tesseractReady) {
                statusDiv.textContent = "Le moteur OCR n'est pas encore prêt. Veuillez patienter.";
                return;
            }

            statusDiv.textContent = "Capture et analyse en cours... Veuillez patienter.";
            resultDiv.textContent = "VIN : Analyse en cours...";
            resultDiv.style.color = '#0056B3';
            captureButton.disabled = true;

            try {
                const overlay = document.getElementById('vinOverlay');
                const videoRect = video.getBoundingClientRect();
                const overlayRect = overlay.getBoundingClientRect();

                const scaleX = canvas.width / videoRect.width;
                const scaleY = canvas.height / videoRect.height;
                
                const sx = (overlayRect.left - videoRect.left) * scaleX;
                const sy = (overlayRect.top - videoRect.top) * scaleY;
                const sWidth = overlayRect.width * scaleX;
                const sHeight = overlayRect.height * scaleY;

                context.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);

                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                let src = cv.matFromImageData(imageData);

                let gray = new cv.Mat();
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

                let clahe = new cv.CLAHE(4, new cv.Size(8, 8));
                clahe.apply(gray, gray);
                clahe.delete();

                let denoised = new cv.Mat();
                cv.bilateralFilter(gray, denoised, 9, 75, 75, cv.BORDER_DEFAULT);
                gray.delete();

                let binary = new cv.Mat();
                cv.adaptiveThreshold(denoised, binary, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 2);
                denoised.delete();

                let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(2, 2));
                cv.morphologyEx(binary, binary, cv.MORPH_OPEN, kernel);
                kernel.delete();
                
                cv.imshow('canvas', binary);
                const processedImageDataURL = canvas.toDataURL('image/png');

                src.delete();
                binary.delete();

                const { data: { text } } = await tesseractWorker.recognize(processedImageDataURL);

                const recognizedVIN = text.trim();
                let validatedVIN = validateVIN(recognizedVIN);

                if (validatedVIN) {
                    resultDiv.textContent = `VIN : ${validatedVIN}`;
                    resultDiv.style.color = '#2E8B57';
                    statusDiv.textContent = 'VIN reconnu et validé avec succès !';
                } else {
                    const correctedVIN = tryCorrectCommonOcrErrors(recognizedVIN);
                    validatedVIN = validateVIN(correctedVIN);

                    if (validatedVIN) {
                        resultDiv.textContent = `VIN : ${validatedVIN} (Corrigé et Validé)`;
                        resultDiv.style.color = '#FFD700';
                        statusDiv.textContent = 'VIN reconnu et corrigé automatiquement. Veuillez vérifier.';
                    } else {
                        resultDiv.textContent = `VIN : "${recognizedVIN}" (Non valide)`;
                        resultDiv.style.color = '#E31937';
                        statusDiv.textContent = 'VIN illisible ou format incorrect. Veuillez ajuster le cadrage et réessayer.';
                    }
                }

            } catch (ocrError) {
                console.error("Erreur lors de la reconnaissance OCR: ", ocrError);
                resultDiv.textContent = "VIN : Erreur interne lors de l'analyse.";
                resultDiv.style.color = '#E31937';
                statusDiv.textContent = "Une erreur grave est survenue pendant l'analyse OCR.";
            } finally {
                captureButton.disabled = false;
            }
        });
    </script>

    <script src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
</body>
</html>
