<!DOCTYPE html>
<html lang="fr-ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner VIN | VendreTonAutoRapide.ca</title>
    <style>
        /* [Vos styles CSS existants restent inchangés] */
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/@zxing/library@0.19.1"></script>
</head>
<body>
    <!-- [Votre HTML existant reste inchangé] -->

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const returnUrl = urlParams.get('returnUrl') || 'eval.html';
            const codeReader = new ZXing.BrowserMultiFormatReader();
            const videoElement = document.getElementById('scanner-video');
            let scanTimeout;

            try {
                // Démarrer le scanner
                const result = await codeReader.decodeFromVideoDevice(null, videoElement, (result, error) => {
                    if (result) {
                        const scannedVin = result.text.toUpperCase();
                        if (/^[A-HJ-NPR-Z0-9]{17}$/.test(scannedVin)) {
                            // VIN valide trouvé
                            clearTimeout(scanTimeout);
                            codeReader.reset();
                            window.location.href = `${returnUrl}${returnUrl.includes('?') ? '&' : '?'}scannedVin=${encodeURIComponent(scannedVin)}`;
                        }
                    }
                    
                    if (error && !(error instanceof ZXing.NotFoundException)) {
                        console.error('Erreur de scan:', error);
                    }
                });

                // Timeout après 30 secondes d'inactivité
                scanTimeout = setTimeout(() => {
                    codeReader.reset();
                    alert('Temps écoulé. Aucun VIN valide détecté.');
                    window.location.href = returnUrl;
                }, 30000);

            } catch (error) {
                console.error('Erreur initialisation scanner:', error);
                alert('Erreur d\'accès à la caméra. Veuillez vérifier les permissions.');
                window.location.href = returnUrl;
            }

            // Bouton Annuler
            document.getElementById('cancel-scan').addEventListener('click', () => {
                clearTimeout(scanTimeout);
                codeReader.reset();
                window.location.href = returnUrl;
            });
        });
    </script>
</body>
</html>
