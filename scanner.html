<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner VIN avec changement de cam√©ra</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #f0f0f5;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #222;
    }
    #container {
      background: white;
      padding: 25px 30px 40px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      width: 95%;
      max-width: 800px;
      text-align: center;
    }
    h1 {
      margin-bottom: 18px;
      font-weight: 700;
      color: #E31937;
    }
    #reader {
      margin: 20px auto;
      width: 100%;
      max-width: 600px;
      height: 400px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 12px rgba(0,0,0,0.2);
      position: relative;
    }
    #scan-region {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 30%;
      border: 3px solid #E31937;
      border-radius: 8px;
      z-index: 10;
      pointer-events: none;
    }
    #vin-display {
      margin-top: 20px;
      font-size: 22px;
      font-weight: 600;
      word-break: break-word;
      min-height: 28px;
      color: #222;
    }
    #status {
      margin-top: 10px;
      font-size: 18px;
      font-weight: 500;
      color: #666;
      min-height: 24px;
    }
    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      justify-content: center;
      flex-wrap: wrap;
    }
    button {
      background-color: #E31937;
      color: white;
      border: none;
      padding: 14px 30px;
      font-size: 18px;
      font-weight: 600;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      outline-offset: 2px;
      flex: 1;
      min-width: 180px;
    }
    button:hover {
      background-color: #b21427;
    }
    button.secondary {
      background-color: #0056B3;
    }
    button.secondary:hover {
      background-color: #003d7a;
    }
    #camera-switch {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    #zoom-controls {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    #zoom-controls button {
      min-width: 50px;
      padding: 10px;
      font-size: 16px;
    }
    @media (max-width: 768px) {
      #reader {
        height: 300px;
      }
      button {
        padding: 12px 20px;
        font-size: 16px;
        min-width: 140px;
      }
    }
  </style>
</head>
<body>

  <div id="container">
    <h1>Scanner le VIN</h1>
    <div id="reader">
      <div id="scan-region"></div>
    </div>
    <div id="vin-display">Aucun VIN scann√©</div>
    <div id="status">Initialisation de la cam√©ra...</div>
    
    <div id="zoom-controls">
      <button id="zoom-in" class="secondary"><i class="fas fa-search-plus"></i></button>
      <button id="zoom-out" class="secondary"><i class="fas fa-search-minus"></i></button>
      <button id="zoom-reset" class="secondary"><i class="fas fa-sync-alt"></i></button>
    </div>
    
    <div class="button-group">
      <button id="switch-btn" class="secondary">
        <span id="camera-switch">
          <i class="fas fa-camera"></i> Changer de cam√©ra
        </span>
      </button>
      <button id="stop-btn">Arr√™ter le scan</button>
    </div>
  </div>

  <!-- Font Awesome pour les ic√¥nes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <script>
    const vinDisplay = document.getElementById('vin-display');
    const status = document.getElementById('status');
    const stopBtn = document.getElementById('stop-btn');
    const switchBtn = document.getElementById('switch-btn');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const zoomResetBtn = document.getElementById('zoom-reset');
    const scanRegion = document.getElementById('scan-region');

    const html5QrCode = new Html5Qrcode("reader");
    let currentCamera = 'environment'; // 'environment' = cam√©ra arri√®re, 'user' = cam√©ra avant
    let isScanning = false;
    let currentStream = null;
    let currentZoom = 1;

    // Configuration du focus automatique
    async function configureFocus(stream) {
      if (!stream) return;
      
      const videoTrack = stream.getVideoTracks()[0];
      if (!videoTrack) return;
      
      const capabilities = videoTrack.getCapabilities();
      const settings = videoTrack.getSettings();
      
      // V√©rifie si le focus est support√©
      if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
        try {
          await videoTrack.applyConstraints({
            advanced: [{ focusMode: 'continuous' }]
          });
          console.log("Focus automatique activ√©");
        } catch (err) {
          console.warn("Impossible d'activer le focus automatique:", err);
        }
      }
      
      // Sauvegarde le stream pour les contr√¥les de zoom
      currentStream = stream;
    }

    // Fonction pour ajuster le zoom
    async function adjustZoom(zoomFactor) {
      if (!currentStream) return;
      
      const videoTrack = currentStream.getVideoTracks()[0];
      if (!videoTrack) return;
      
      const capabilities = videoTrack.getCapabilities();
      const settings = videoTrack.getSettings();
      
      if (capabilities.zoom) {
        try {
          let newZoom = currentZoom * zoomFactor;
          
          // Limite le zoom aux capacit√©s de la cam√©ra
          newZoom = Math.max(capabilities.zoom.min, Math.min(capabilities.zoom.max, newZoom));
          
          await videoTrack.applyConstraints({
            advanced: [{ zoom: newZoom }]
          });
          
          currentZoom = newZoom;
          console.log("Zoom ajust√© √†:", currentZoom);
        } catch (err) {
          console.warn("Impossible d'ajuster le zoom:", err);
        }
      }
    }

    async function startScanner(cameraType) {
      try {
        // Arr√™ter le scan en cours si actif
        if (isScanning) {
          await html5QrCode.stop();
          isScanning = false;
          if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
          }
        }

        // D√©marrer avec le type de cam√©ra sp√©cifi√©
        status.textContent = `Initialisation de la cam√©ra ${cameraType === 'environment' ? 'arri√®re' : 'avant'}...`;
        status.style.color = "#666";
        
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 150 },
          experimentalFeatures: { 
            useBarCodeDetectorIfSupported: true,
          },
          supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
        };
        
        const cameraConfig = cameraType === 'environment' 
          ? { facingMode: { exact: "environment" } } 
          : { facingMode: "user" };
        
        await html5QrCode.start(
          cameraConfig,
          config,
          decodedText => {
            const vin = decodedText.trim().toUpperCase();
            vinDisplay.textContent = `VIN scann√© : ${vin}`;

            if (/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
              status.textContent = "‚úÖ VIN valide";
              status.style.color = "#1a7f37";
              // Optionnel : Arr√™ter apr√®s un scan r√©ussi
              // html5QrCode.stop().then(() => {
              //   window.opener.postMessage({ vin: vin }, window.location.origin);
              //   window.close();
              // });
            } else {
              status.textContent = "‚ö†Ô∏è VIN invalide (17 caract√®res sans I,O,Q)";
              status.style.color = "#b24343";
            }
          },
          errorMessage => {
            // Ignorer les erreurs de scan normales
          }
        ).then(stream => {
          configureFocus(stream);
          return stream;
        });

        isScanning = true;
        currentCamera = cameraType;
        status.textContent = `üéØ Scan en cours (cam√©ra ${cameraType === 'environment' ? 'arri√®re' : 'avant'})... Positionnez le VIN dans la zone de scan.`;
        status.style.color = "#666";
        
      } catch (err) {
        status.textContent = `Erreur cam√©ra: ${err.message || err}`;
        status.style.color = "#b24343";
        console.error("Erreur de d√©marrage de la cam√©ra:", err);
        
        // Tenter l'autre cam√©ra en fallback
        const fallbackCamera = cameraType === 'environment' ? 'user' : 'environment';
        status.textContent += ` Tentative avec la cam√©ra ${fallbackCamera === 'environment' ? 'arri√®re' : 'avant'}...`;
        
        try {
          await startScanner(fallbackCamera);
        } catch (fallbackErr) {
          status.textContent = `Erreur irr√©cup√©rable: Aucune cam√©ra fonctionnelle. ${fallbackErr.message || fallbackErr}`;
          status.style.color = "#b24343";
          console.error("Erreur de d√©marrage de la cam√©ra de fallback:", fallbackErr);
        }
      }
    }

    // Bouton pour changer de cam√©ra
    switchBtn.addEventListener('click', async () => {
      const newCamera = currentCamera === 'environment' ? 'user' : 'environment';
      await startScanner(newCamera);
    });

    // Bouton pour arr√™ter le scan
    stopBtn.addEventListener('click', async () => {
      try {
        await html5QrCode.stop();
        isScanning = false;
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
          currentStream = null;
        }
        status.textContent = "‚èπÔ∏è Scan arr√™t√©.";
        status.style.color = "#666";
      } catch (err) {
        status.textContent = `Erreur √† l'arr√™t: ${err}`;
        status.style.color = "#b24343";
      }
    });

    // Contr√¥les de zoom
    zoomInBtn.addEventListener('click', () => adjustZoom(1.2));
    zoomOutBtn.addEventListener('click', () => adjustZoom(0.8));
    zoomResetBtn.addEventListener('click', async () => {
      currentZoom = 1;
      if (currentStream) {
        const videoTrack = currentStream.getVideoTracks()[0];
        if (videoTrack) {
          try {
            await videoTrack.applyConstraints({
              advanced: [{ zoom: currentZoom }]
            });
          } catch (err) {
            console.warn("Impossible de r√©initialiser le zoom:", err);
          }
        }
      }
    });

    // D√©marrer initialement avec la cam√©ra arri√®re
    startScanner('environment');
  </script>

</body>
</html>
