<!DOCTYPE html>
<html lang="fr-ca">
<head>
  <meta charset="UTF-8">
  <title>Scanner VIN & d√©codage</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      text-align: center;
      padding: 20px;
    }
    #reader {
      width: 100%;
      max-width: 500px;
      margin: auto;
    }
    #vin-display, #api-result {
      margin-top: 20px;
      font-size: 18px;
      white-space: pre-wrap;
    }
    #output {
      margin-top: 10px;
      font-size: 16px;
      color: #E31937;
    }
    button {
      background-color: #E31937;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h1>Scanner le VIN</h1>
  <div id="reader"></div>
  <div id="vin-display">Aucun VIN d√©tect√©</div>
  <div id="output">En attente du scan...</div>
  <div id="api-result"></div>
  <button id="stop-scan">Arr√™ter</button>

  <script>
    const vinDisplay = document.getElementById("vin-display");
    const output = document.getElementById("output");
    const apiResult = document.getElementById("api-result");
    const stopBtn = document.getElementById("stop-scan");
    const html5QrCode = new Html5Qrcode("reader");

    function decodeVIN(vin) {
      fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVin/${vin}?format=json`)
        .then(response => response.json())
        .then(data => {
          const results = data.Results;
          const make = results.find(r => r.Variable === "Make")?.Value || "Inconnu";
          const model = results.find(r => r.Variable === "Model")?.Value || "Inconnu";
          const year = results.find(r => r.Variable === "Model Year")?.Value || "Inconnu";
          apiResult.innerText = `üöó Marque : ${make}\nüìò Mod√®le : ${model}\nüìÖ Ann√©e : ${year}`;
        })
        .catch(error => {
          apiResult.innerText = "‚ùå Erreur lors de l'appel √† l'API.";
          console.error(error);
        });
    }

    Html5Qrcode.getCameras().then(devices => {
      if (devices.length === 0) {
        output.textContent = "‚ùå Aucune cam√©ra d√©tect√©e.";
        return;
      }

      // Cherche la cam√©ra arri√®re
      const backCam = devices.find(d =>
        d.label.toLowerCase().includes("back") ||
        d.label.toLowerCase().includes("environment") ||
        d.label.toLowerCase().includes("rear")
      ) || devices[0];

      html5QrCode.start(
        backCam.id,
        { fps: 10, qrbox: { width: 300, height: 200 } },
        (decodedText) => {
          const vin = decodedText.trim().toUpperCase();
          vinDisplay.textContent = `Scann√© : ${vin}`;

          if (/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
            output.textContent = "‚úÖ VIN valide. D√©codage en cours...";
            decodeVIN(vin);
          } else {
            output.textContent = "‚ö†Ô∏è Format VIN invalide (17 caract√®res sans I, O, Q)";
            apiResult.innerText = "";
          }
        },
        (err) => { /* Erreurs ignor√©es */ }
      );
    }).catch(err => {
      output.textContent = `‚ùå Erreur cam√©ra : ${err}`;
    });

    stopBtn.addEventListener("click", () => {
      html5QrCode.stop().then(() => window.close());
    });
  </script>

</body>
</html>
