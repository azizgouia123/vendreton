<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner VIN Instantané - VendreTonAutoRapide.ca</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        #camera { width: 100%; max-width: 600px; background: #000; border-radius: 8px; }
        #scan-btn { background: #E31937; color: white; border: none; padding: 15px 30px; font-size: 1.2em; border-radius: 8px; cursor: pointer; margin: 20px 0; }
        #result { font-size: 1.3em; font-weight: bold; margin-top: 20px; padding: 15px; border-radius: 8px; }
        .valid { background: #e6f7ff; color: #2E8B57; }
        .invalid { background: #ffebee; color: #E31937; }
    </style>
</head>
<body>
    <h1>SCANNEZ VOTRE VIN EN 2 SECONDES</h1>
    <video id="camera" playsinline autoplay muted></video>
    <button id="scan-btn">LANCER LE SCAN</button>
    <div id="result">Prêt à scanner</div>

    <script>
        // 1. Démarrer la caméra IMMÉDIATEMENT
        const video = document.getElementById('camera');
        const scanBtn = document.getElementById('scan-btn');
        const resultDiv = document.getElementById('result');
        
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => video.srcObject = stream)
            .catch(() => navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => video.srcObject = stream)
                .catch(err => resultDiv.textContent = "ERREUR: Caméra bloquée")
            );

        // 2. Solution OCR Réelle avec Tesseract.js
        scanBtn.addEventListener('click', async () => {
            resultDiv.textContent = "Analyse en cours...";
            
            // Capture de l'image
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // Chargement DYNAMIQUE de Tesseract (seulement au premier clic)
            if (!window.Tesseract) {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
                document.head.appendChild(script);
                await new Promise(resolve => script.onload = resolve);
            }
            
            // Détection RÉELLE du VIN
            const worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            await worker.setParameters({
                tessedit_char_whitelist: '0123456789ABCDEFGHJKLMNPRSTUVWXYZ',
                tessedit_pageseg_mode: '7'
            });
            
            const { data: { text } } = await worker.recognize(canvas);
            const vin = cleanVin(text);
            
            resultDiv.textContent = vin ? `VIN DÉTECTÉ: ${vin}` : "VIN NON RECONNU";
            resultDiv.className = vin ? 'valid' : 'invalid';
            
            worker.terminate();
        });
        
        // Nettoyage du VIN
        function cleanVin(text) {
            const vin = text.replace(/[\s\W]/g, '').toUpperCase();
            return vin.length === 17 && !/[IOQ]/.test(vin) ? vin : null;
        }
    </script>
</body>
</html>
