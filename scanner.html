<!DOCTYPE html>
<html lang="fr-ca">
<head>
  <meta charset="UTF-8">
  <title>Scanner VIN</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      text-align: center;
      padding: 20px;
    }
    #reader {
      width: 100%;
      max-width: 500px;
      margin: auto;
    }
    #vin-display {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
    }
    #output {
      margin-top: 10px;
      font-size: 16px;
      color: #E31937;
    }
    button {
      background-color: #E31937;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h1>Scanner le VIN</h1>
  <div id="reader"></div>
  <div id="vin-display">Aucun VIN détecté</div>
  <div id="output">En attente de scan...</div>
  <button id="stop-scan">Arrêter</button>

  <script>
    const vinDisplay = document.getElementById("vin-display");
    const output = document.getElementById("output");
    const stopBtn = document.getElementById("stop-scan");
    const html5QrCode = new Html5Qrcode("reader");

    // Fonction de démarrage avec caméra arrière
    Html5Qrcode.getCameras().then(devices => {
      if (devices.length === 0) {
        output.textContent = "❌ Aucune caméra détectée.";
        return;
      }

      // Recherche d'une caméra arrière (back, environment, rear)
      const backCamera = devices.find(d =>
        d.label.toLowerCase().includes("back") ||
        d.label.toLowerCase().includes("rear") ||
        d.label.toLowerCase().includes("environment")
      ) || devices[0]; // fallback caméra si pas de label

      html5QrCode.start(
        backCamera.id,
        {
          fps: 10,
          qrbox: { width: 300, height: 200 }
        },
        (decodedText) => {
          const vin = decodedText.trim().toUpperCase();
          vinDisplay.textContent = `Scanné : ${vin}`;

          // Vérifie si le code correspond à un VIN valide
          if (/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
            output.textContent = "✅ VIN valide détecté. Fermeture...";
            window.opener?.postMessage({ type: 'VIN_SCANNED', vin }, '*');
            html5QrCode.stop().then(() => window.close());
          } else {
            output.textContent = "⚠️ Format VIN invalide (17 caractères alphanumériques, sans I, O, Q)";
          }
        },
        (errorMessage) => {
          // On peut ignorer les erreurs temporaires de scan
        }
      );
    }).catch(err => {
      output.textContent = `❌ Erreur lors de l'accès à la caméra : ${err}`;
    });

    stopBtn.addEventListener("click", () => {
      html5QrCode.stop().then(() => window.close());
    });
  </script>

</body>
</html>
