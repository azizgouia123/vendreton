<!DOCTYPE html>
<html lang="fr">
<head>
Â  <meta charset="UTF-8" />
Â  <title>Scanner VIN</title>
Â  <script src="https://unpkg.com/html5-qrcode"></script>
Â  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet" />
Â  <style>
Â  Â  body {
Â  Â  Â  font-family: 'Montserrat', sans-serif;
Â  Â  Â  background-color: #f0f0f5;
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 40px 10px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  Â  min-height: 100vh;
Â  Â  Â  color: #222;
Â  Â  }
Â  Â  #container {
Â  Â  Â  background: white;
Â  Â  Â  padding: 25px 30px 40px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
Â  Â  Â  max-width: 440px;
Â  Â  Â  width: 100%;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  h1 {
Â  Â  Â  margin-bottom: 18px;
Â  Â  Â  font-weight: 700;
Â  Â  Â  color: #E31937;
Â  Â  }
Â  Â  #reader {
Â  Â  Â  margin: auto;
Â  Â  Â  width: 100%;
Â  Â  Â  max-width: 400px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  overflow: hidden;
Â  Â  Â  box-shadow: 0 0 12px rgba(0,0,0,0.2);
Â  Â  }
Â  Â  #vin-display {
Â  Â  Â  margin-top: 20px;
Â  Â  Â  font-size: 20px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  word-break: break-word;
Â  Â  Â  min-height: 28px;
Â  Â  Â  color: #222;
Â  Â  }
Â  Â  #status {
Â  Â  Â  margin-top: 6px;
Â  Â  Â  font-size: 16px;
Â  Â  Â  font-weight: 500;
Â  Â  Â  color: #666;
Â  Â  Â  min-height: 20px;
Â  Â  }
Â  Â  .button-group {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  gap: 15px; /* Espace entre les boutons */
Â  Â  Â  margin-top: 30px;
Â  Â  Â  flex-wrap: wrap; /* Pour les petits Ã©crans */
Â  Â  }
Â  Â  button {
Â  Â  Â  background-color: #E31937;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  font-size: 17px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  border-radius: 30px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background-color 0.3s ease;
Â  Â  Â  user-select: none;
Â  Â  Â  outline-offset: 2px;
Â  Â  Â  flex-grow: 1; /* Permet aux boutons de grandir pour remplir l'espace */
Â  Â  Â  max-width: 180px; /* Limite la largeur maximale des boutons */
Â  Â  }
Â  Â  button:hover {
Â  Â  Â  background-color: #b21427;
Â  Â  }
Â  Â  button:disabled {
Â  Â  Â  background-color: #cccccc;
Â  Â  Â  cursor: not-allowed;
Â  Â  }
Â  Â  #camera-select {
Â  Â  Â  margin-top: 20px;
Â  Â  Â  padding: 10px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  font-size: 16px;
Â  Â  Â  width: calc(100% - 40px); /* Pour s'aligner avec le conteneur */
Â  Â  Â  max-width: 400px;
Â  Â  Â  display: none; /* CachÃ© par dÃ©faut */
Â  Â  }
Â  </style>
</head>
<body>

Â  <div id="container">
Â  Â  <h1>Scanner le VIN</h1>
Â  Â  <div id="reader"></div>
Â  Â  <div id="vin-display">Aucun VIN scannÃ©</div>
Â  Â  <div id="status">En attente du scan...</div>

Â  Â  <select id="camera-select" title="SÃ©lectionner une camÃ©ra"></select>

Â  Â  <div class="button-group">
Â  Â  Â  <button id="start-btn">DÃ©marrer le scan</button>
Â  Â  Â  <button id="stop-btn" disabled>ArrÃªter le scan</button>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  const vinDisplay = document.getElementById('vin-display');
Â  Â  const status = document.getElementById('status');
Â  Â  const startBtn = document.getElementById('start-btn');
Â  Â  const stopBtn = document.getElementById('stop-btn');
Â  Â  const cameraSelect = document.getElementById('camera-select');

Â  Â  const html5QrCode = new Html5Qrcode("reader");
Â  Â  let currentCameraId = null; // ID de la camÃ©ra actuellement utilisÃ©e
Â  Â  let availableCameras = []; // Liste des camÃ©ras dÃ©tectÃ©es

Â  Â  // Fonction pour mettre Ã  jour l'Ã©tat des boutons
Â  Â  function updateButtonStates(isScanning) {
Â  Â  Â  startBtn.disabled = isScanning;
Â  Â  Â  stopBtn.disabled = !isScanning;
Â  Â  Â  cameraSelect.disabled = isScanning;
Â  Â  }

Â  Â  // Initialise la liste des camÃ©ras disponibles
Â  Â  async function populateCameraSelect() {
Â  Â  Â  try {
Â  Â  Â  Â  availableCameras = await Html5Qrcode.getCameras();
Â  Â  Â  Â  cameraSelect.innerHTML = ''; // Vide les options prÃ©cÃ©dentes

Â  Â  Â  Â  if (availableCameras && availableCameras.length > 0) {
Â  Â  Â  Â  Â  cameraSelect.style.display = 'block'; // Affiche la liste dÃ©roulante

Â  Â  Â  Â  Â  availableCameras.forEach(camera => {
Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  option.value = camera.id;
Â  Â  Â  Â  Â  Â  // Tente de donner un nom plus descriptif
Â  Â  Â  Â  Â  Â  let cameraName = camera.label || `CamÃ©ra ${camera.id.substring(0, 5)}...`;
Â  Â  Â  Â  Â  Â  if (cameraName.toLowerCase().includes("back") || cameraName.toLowerCase().includes("rear") || cameraName.toLowerCase().includes("environment")) {
Â  Â  Â  Â  Â  Â  Â  cameraName += " (ArriÃ¨re)";
Â  Â  Â  Â  Â  Â  } else if (cameraName.toLowerCase().includes("front") || cameraName.toLowerCase().includes("user")) {
Â  Â  Â  Â  Â  Â  Â  cameraName += " (Avant)";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  option.textContent = cameraName;
Â  Â  Â  Â  Â  Â  cameraSelect.appendChild(option);
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  // Tente de sÃ©lectionner la camÃ©ra arriÃ¨re par dÃ©faut
Â  Â  Â  Â  Â  const backCamera = availableCameras.find(device =>
Â  Â  Â  Â  Â  Â  device.label.toLowerCase().includes("back") ||
Â  Â  Â  Â  Â  Â  device.label.toLowerCase().includes("rear") ||
Â  Â  Â  Â  Â  Â  device.label.toLowerCase().includes("environment")
Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  if (backCamera) {
Â  Â  Â  Â  Â  Â  cameraSelect.value = backCamera.id;
Â  Â  Â  Â  Â  Â  currentCameraId = backCamera.id;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Si pas de camÃ©ra arriÃ¨re trouvÃ©e, sÃ©lectionne la premiÃ¨re
Â  Â  Â  Â  Â  Â  cameraSelect.value = availableCameras[0].id;
Â  Â  Â  Â  Â  Â  currentCameraId = availableCameras[0].id;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // DÃ©marre le scan automatiquement avec la camÃ©ra sÃ©lectionnÃ©e (arriÃ¨re par dÃ©faut)
Â  Â  Â  Â  Â  startScanner(currentCameraId);

Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  status.textContent = "âŒ Aucune camÃ©ra dÃ©tectÃ©e sur cet appareil.";
Â  Â  Â  Â  Â  status.style.color = "#b24343";
Â  Â  Â  Â  Â  startBtn.disabled = true;
Â  Â  Â  Â  Â  cameraSelect.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  status.textContent = `Erreur lors de la dÃ©tection des camÃ©ras: ${err.message || err}. VÃ©rifiez les permissions.`;
Â  Â  Â  Â  status.style.color = "#b24343";
Â  Â  Â  Â  startBtn.disabled = true;
Â  Â  Â  Â  cameraSelect.style.display = 'none';
Â  Â  Â  Â  console.error("Erreur Html5Qrcode.getCameras():", err);
Â  Â  Â  }
Â  Â  }

Â  Â  // Fonction pour dÃ©marrer le scanner avec un ID de camÃ©ra donnÃ©
Â  Â  async function startScanner(cameraId) {
Â  Â  Â  if (html5QrCode.is	Scanning) {
Â  Â  Â  Â  await html5QrCode.stop(); // ArrÃªte le scan actuel si un autre est en cours
Â  Â  Â  }
Â  Â  Â  currentCameraId = cameraId; // Met Ã  jour l'ID de la camÃ©ra courante

Â  Â  Â  try {
Â  Â  Â  Â  updateButtonStates(true); // DÃ©sactive le bouton de dÃ©marrage, active l'arrÃªt
Â  Â  Â  Â  status.textContent = "ðŸŽ¯ Scan en cours... Positionnez le VIN devant la camÃ©ra.";
Â  Â  Â  Â  status.style.color = "#666";
Â  Â  Â  Â  vinDisplay.textContent = "Aucun VIN scannÃ©"; // RÃ©initialise l'affichage du VIN

Â  Â  Â  Â  await html5QrCode.start(
Â  Â  Â  Â  Â  cameraId, // Utilise l'ID de la camÃ©ra sÃ©lectionnÃ©e
Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  fps: 10,
Â  Â  Â  Â  Â  Â  qrbox: { width: 320, height: 100 },
Â  Â  Â  Â  Â  Â  experimentalFeatures: { useBarCodeDetectorIfSupported: true }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  decodedText => {
Â  Â  Â  Â  Â  Â  const vin = decodedText.trim().toUpperCase();
Â  Â  Â  Â  Â  Â  vinDisplay.textContent = `VIN scannÃ© : ${vin}`;

Â  Â  Â  Â  Â  Â  if (/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
Â  Â  Â  Â  Â  Â  Â  status.textContent = "âœ… VIN valide";
Â  Â  Â  Â  Â  Â  Â  status.style.color = "#1a7f37";
Â  Â  Â  Â  Â  Â  Â  // Optionnel : Envoyer le VIN et fermer la fenÃªtre
Â  Â  Â  Â  Â  Â  Â  if (window.opener) {
Â  Â  Â  Â  Â  Â  Â  Â  window.opener.postMessage({ vin: vin }, window.location.origin);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  html5QrCode.stop().then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { // Donne un peu de temps pour la fermeture propre
Â  Â  Â  Â  Â  Â  Â  Â  Â  window.close();
Â  Â  Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  Â  Â  Â  }).catch(e => console.error("Erreur Ã  l'arrÃªt aprÃ¨s VIN valide:", e));

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  status.textContent = "âš ï¸ VIN invalide (17 caractÃ¨res sans I,O,Q)";
Â  Â  Â  Â  Â  Â  Â  status.style.color = "#b24343";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  errorMessage => {
Â  Â  Â  Â  Â  Â  // Erreurs de dÃ©tection classiques, ignorÃ©es pour ne pas surcharger le statut
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  );
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  status.textContent = `Erreur de dÃ©marrage de la camÃ©ra: ${err.message || err}. VÃ©rifiez les permissions.`;
Â  Â  Â  Â  status.style.color = "#b24343";
Â  Â  Â  Â  updateButtonStates(false); // RÃ©active le bouton de dÃ©marrage
Â  Â  Â  Â  console.error("Erreur de dÃ©marrage html5QrCode.start():", err);
Â  Â  Â  }
Â  Â  }

Â  Â  // Ã‰vÃ©nements des boutons et du sÃ©lecteur
Â  Â  startBtn.addEventListener('click', () => {
Â  Â  Â  if (currentCameraId) {
Â  Â  Â  Â  startScanner(currentCameraId);
Â  Â  Â  } else if (availableCameras.length > 0) {
Â  Â  Â  Â  startScanner(availableCameras[0].id); // DÃ©marre la premiÃ¨re si aucune n'est sÃ©lectionnÃ©e
Â  Â  Â  } else {
Â  Â  Â  Â  status.textContent = "Impossible de dÃ©marrer: aucune camÃ©ra disponible.";
Â  Â  Â  Â  status.style.color = "#b24343";
Â  Â  Â  }
Â  Â  });

Â  Â  stopBtn.addEventListener('click', async () => {
Â  Â  Â  if (html5QrCode.isScanning) {
Â  Â  Â  Â  await html5QrCode.stop();
Â  Â  Â  Â  status.textContent = "â¹ï¸ Scan arrÃªtÃ©.";
Â  Â  Â  Â  status.style.color = "#666";
Â  Â  Â  Â  updateButtonStates(false);
Â  Â  Â  }
Â  Â  });

Â  Â  cameraSelect.addEventListener('change', (event) => {
Â  Â  Â  currentCameraId = event.target.value;
Â  Â  Â  // RedÃ©marre le scanner avec la nouvelle camÃ©ra si un scan Ã©tait en cours
Â  Â  Â  if (!html5QrCode.isScanning) { // Si le scan est dÃ©jÃ  arrÃªtÃ©, ne le redÃ©marre pas automatiquement.
Â  Â  Â  Â  status.textContent = "CamÃ©ra sÃ©lectionnÃ©e. Cliquez sur 'DÃ©marrer le scan'.";
Â  Â  Â  Â  status.style.color = "#666";
Â  Â  Â  } else {
Â  Â  Â  Â  startScanner(currentCameraId);
Â  Â  Â  }
Â  Â  });

Â  Â  // Initialisation: dÃ©tecte les camÃ©ras et dÃ©marre avec la camÃ©ra par dÃ©faut (arriÃ¨re si possible)
Â  Â  populateCameraSelect();
Â  </script>

</body>
</html>
