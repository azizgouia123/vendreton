<!DOCTYPE html>
<html lang="fr-ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner VIN | VendreTonAutoRapide.ca</title>
    <script src='https://unpkg.com/tesseract.js@5.0.0/dist/tesseract.min.js'></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #0056B3; /* Primary Blue */
            margin-bottom: 20px;
            font-size: 2em;
        }
        #videoElement {
            width: 100%;
            max-width: 500px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #000;
            margin-bottom: 20px;
        }
        #canvas {
            display: none; /* Hidden, used for capturing frames */
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .btn {
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: white;
            background-color: #E31937; /* Secondary Red */
        }
        .btn:hover {
            background-color: #C0112B;
            transform: translateY(-2px);
        }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #0056B3;
            border-radius: 8px;
            background-color: #e6f2ff;
            color: #333;
            font-size: 1.1em;
            word-break: break-all; /* Allow long VINs to wrap */
        }
        #loadingMessage {
            margin-top: 15px;
            font-style: italic;
            color: #555;
        }
        .feedback {
            margin-top: 10px;
            font-weight: bold;
        }
        .success {
            color: #28a745; /* Green */
        }
        .error {
            color: #dc3545; /* Red */
        }
        .info {
            color: #007bff; /* Blue */
        }
        @media (max-width: 480px) {
            .btn {
                font-size: 1em;
                padding: 10px 20px;
            }
            h1 {
                font-size: 1.5em;
            }
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Scanner le Numéro VIN</h1>
        <p>Positionnez le VIN de votre véhicule dans le cadre ci-dessous.</p>
        <video id="videoElement" playsinline autoplay></video>
        <canvas id="canvas"></canvas>
        <div class="controls">
            <button id="captureBtn" class="btn" disabled>Capturer et Scanner le VIN</button>
        </div>
        <div id="loadingMessage"></div>
        <div id="result" style="display: none;">
            VIN Scanné: <strong id="vinDisplay"></strong><br>
            Statut: <span id="statusDisplay"></span>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('videoElement');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const captureBtn = document.getElementById('captureBtn');
        const loadingMessage = document.getElementById('loadingMessage');
        const vinDisplay = document.getElementById('vinDisplay');
        const statusDisplay = document.getElementById('statusDisplay');
        const resultDiv = document.getElementById('result');

        let worker; // Tesseract.js worker
        let stream; // MediaStream for camera

        // Initialise la caméra
        async function initCamera() {
            loadingMessage.textContent = "Démarrage de la caméra...";
            try {
                // Try facingMode: environment first for rear camera
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                videoElement.srcObject = stream;
                await videoElement.play();
                loadingMessage.textContent = "Caméra prête.";
                captureBtn.disabled = false;
            } catch (err) {
                console.error("Erreur d'accès à la caméra arrière: ", err);
                loadingMessage.textContent = "Échec du démarrage de la caméra arrière. Tentative avec la caméra par défaut...";
                // Fallback to any available camera if 'environment' fails
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    videoElement.srcObject = stream;
                    await videoElement.play();
                    loadingMessage.textContent = "Caméra prête (par défaut).";
                    captureBtn.disabled = false;
                } catch (err2) {
                    console.error("Aucune caméra accessible: ", err2);
                    loadingMessage.textContent = "Impossible d'accéder à la caméra. Veuillez vérifier les permissions.";
                }
            }
        }

        // Prépare le worker Tesseract.js
        async function prepareOCR() {
            loadingMessage.textContent = "Chargement du moteur OCR (cela peut prendre un moment)...";
            try {
                worker = await Tesseract.createWorker('eng', 1, {
                    // Supprimez le logger pour éviter le DataCloneError
                    // logger: m => {
                    //     if (m.status === 'recognizing') {
                    //         loadingMessage.textContent = `Progression OCR: ${(m.progress * 100).toFixed(0)}%`;
                    //     } else {
                    //         loadingMessage.textContent = `Statut OCR: ${m.status}`;
                    //     }
                    // }
                });
                // Configure Tesseract for VIN recognition
                await worker.reinitialize('eng'); // Reinitialize to apply parameters
                await worker.setParameters({
                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE, // Assume single line of text
                    preserve_interword_spaces: '0', // No spaces in VIN
                    tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ' // Only VIN characters
                });
                loadingMessage.textContent = "Moteur OCR prêt.";
            } catch (err) {
                console.error("Erreur de chargement de Tesseract.js: ", err);
                loadingMessage.textContent = "Erreur lors du chargement du moteur OCR.";
            }
        }

        // Fonction de validation simplifiée du VIN (AJOUTER LE CHECKSUM ICI POUR PLUS DE FIABILITÉ)
        function validateVIN(vin) {
            if (!vin || vin.length !== 17) {
                return false;
            }
            // Caractères non autorisés dans un VIN
            const invalidChars = /[IOQioq]/;
            if (invalidChars.test(vin)) {
                return false;
            }
            // Expressions régulières pour valider le format général (sans checksum)
            const vinPattern = /^[A-HJ-NPR-Z0-9]{17}$/;
            return vinPattern.test(vin);

            // TODO: Pour une validation robuste, IMPLÉMENTEZ L'ALGORITHME DE CHECKSUM VIN ISO 3779/3780 ICI.
            // C'est crucial pour s'assurer que le VIN est non seulement au bon format, mais aussi authentique.
            // Exemple (conceptuel, vous devrez trouver l'implémentation exacte):
            // return calculateVINChecksum(vin) === vin[8]; // où vin[8] est le caractère de checksum
        }

        // Capture la photo et lance l'OCR
        captureBtn.addEventListener('click', async () => {
            if (!worker) {
                alert("Le moteur OCR n'est pas encore prêt. Veuillez patienter.");
                return;
            }
            if (!stream) {
                alert("La caméra n'est pas démarrée.");
                return;
            }

            captureBtn.disabled = true;
            loadingMessage.textContent = "Capture de l'image et reconnaissance du VIN...";
            statusDisplay.textContent = ""; // Clear previous status
            resultDiv.style.display = 'none'; // Hide results until new scan

            // Set canvas dimensions to video dimensions
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            try {
                const { data: { text } } = await worker.recognize(canvas);
                let scannedVin = text.replace(/\s+/g, '').toUpperCase(); // Supprime les espaces et met en majuscules

                // Nettoyage commun des erreurs OCR (si Tesseract confond O/0, I/1, Q/0)
                scannedVin = scannedVin.replace(/O/g, '0')
                                       .replace(/I/g, '1')
                                       .replace(/Q/g, '0');

                vinDisplay.textContent = scannedVin;
                resultDiv.style.display = 'block';

                if (validateVIN(scannedVin)) {
                    statusDisplay.textContent = "VIN valide ! Redirection...";
                    statusDisplay.className = "feedback success";

                    // REDIRECTION VERS EVAL.HTML AVEC LE VIN
                    const urlParams = new URLSearchParams(window.location.search);
                    const returnUrl = urlParams.get('returnUrl');

                    if (returnUrl) {
                        const targetUrl = new URL(returnUrl);
                        targetUrl.searchParams.set('vinScanned', scannedVin); // Ajoutez le VIN comme paramètre
                        window.location.href = targetUrl.toString(); // Redirige
                    } else {
                        // Fallback si pas d'URL de retour (ne devrait pas arriver avec votre setup)
                        alert("VIN scanné avec succès : " + scannedVin + ". Pas d'URL de retour spécifiée.");
                    }
                } else {
                    statusDisplay.textContent = "VIN invalide ou non reconnu. Veuillez réessayer.";
                    statusDisplay.className = "feedback error";
                }
            } catch (error) {
                console.error("Erreur lors de la reconnaissance OCR:", error);
                statusDisplay.textContent = "Erreur lors du scan. Veuillez réessayer.";
                statusDisplay.className = "feedback error";
            } finally {
                loadingMessage.textContent = "";
                captureBtn.disabled = false;
            }
        });

        // Initialisation au chargement de la page
        (async function() {
            await initCamera();
            await prepareOCR();
        })();

        // Arrêter la caméra si l'utilisateur quitte la page
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (worker) {
                worker.terminate();
            }
        });
    </script>
</body>
</html>
